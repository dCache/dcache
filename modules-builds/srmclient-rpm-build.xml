<project name="srmclient-rpm-build">

    <property file="modules-builds/rpms.properties" />

    <target name="srmclient.rpm" depends="srmclient"
            description="Build the dcache-srmclient-xxx.rpm">

        <!-- Copy files for packaging into BUILDROOT -->
        <move todir="${srmclient.rpm.buildroot}">
            <cutdirsmapper dirs="1"/>
            <fileset dir="modules/srmclient/target/">
                <include name="srmclient-*/**"/>
            </fileset>
        </move>

        <!-- Create spec file -->
        <copy todir="${srmclient.rpm.specdir}" overwrite="true">
            <fileset dir="${rpmTemplateDir}">
                <filename name="dcache-srmclient.spec.template" />
            </fileset>
            <mapper type="glob" from="*.template" to="*" />
            <filterset>
                <filter token="Version" value="${version}" />
                <filter token="Release" value="${build.number}" />
            </filterset>
        </copy>

        <!-- work-around for old rpmbuild that require directory to exist -->
        <mkdir dir="${server.rpm.rpmdir}"/>

        <exec executable="rpmbuild" failonerror="true">
            <arg value="--buildroot" />
            <arg file="${srmclient.rpm.buildroot}" />

            <arg value="--define"/>
            <arg value="_topdir ${srmclient.rpm.topdir}"/>

            <arg value="--define"/>
            <arg value="_rpmdir ${srmclient.rpm.rpmdir}"/>

            <arg value="--define"/>
            <arg value="_binary_payload w5.bzdio"/>

            <arg value="-bb" />
            <arg file="${srmclient.rpm.specdir}/dcache-srmclient.spec" />
        </exec>
    </target>
</project>
