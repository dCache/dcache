<project name="server-rpm-build">

    <property file="modules-builds/rpms.properties" />

    <target name="server.rpm" depends="install-server"
	    description="Build /opt/d-cache-distro dcache-server-xxx.rpm">

        <!-- Create spec files for RPM from Templates -->
        <copy todir="${server.rpm.specdir}" overwrite="true">
            <fileset dir="${rpmTemplateDir}">
		<filename name="dcache-server.spec.template" />
            </fileset>
            <mapper type="glob" from="*.template" to="*" />
            <filterset>
                <filter token="Version" value="${version}" />
                <filter token="Release" value="${build.number}" />
            </filterset>
        </copy>

        <!-- Populate BUILDROOT with contents for RPM -->
        <move todir="${server.rpm.buildroot}">
            <fileset dir="${server.root.dir}">
                <include name="**"/>
            </fileset>
        </move>

        <copy file="${rpmTemplateDir}/dcache.bash-completion"
              tofile="${server.rpm.buildroot}/etc/bash_completion.d/dcache"/>

        <exec executable="rpmbuild" failonerror="true">
            <arg value="--buildroot" />
            <arg file="${server.rpm.buildroot}"/>

            <arg value="--define"/>
            <arg value="_topdir ${server.rpm.topdir}"/>

            <arg value="--define"/>
            <arg value="_rpmdir ${server.rpm.rpmdir}"/>

            <arg value="--define"/>
            <arg value="_binary_payload w5.bzdio"/>

            <arg value="-bb" />
            <arg file="${server.rpm.specdir}/dcache-server.spec" />
        </exec>
    </target>



    <target name="server-fhs.rpm" depends="install-server-fhs"
            description="Build the FHS-based dcache-server-fhs-xxx.rpm">

        <!-- Populate BUILDROOT with contents of RPM -->
        <move todir="${server.rpm.buildroot}">
            <fileset dir="${server.root.dir}">
                <include name="**"/>
            </fileset>
        </move>

        <mkdir dir="${server.rpm.buildroot}/etc/rc.d/init.d"/>
        <copy file="${rpmTemplateDir}/dcache-server.init"
              tofile="${server.rpm.buildroot}/etc/rc.d/init.d/dcache-server"/>
        <copy file="${rpmTemplateDir}/dcache.bash-completion"
              tofile="${server.rpm.buildroot}/etc/bash_completion.d/dcache"/>

        <!-- Create spec file from template -->
        <copy todir="${server.rpm.specdir}" overwrite="true">
            <fileset dir="${rpmTemplateDir}">
                <filename name="dcache-server-fhs.spec.template" />
            </fileset>
            <mapper type="glob" from="*.template" to="*"/>
            <filterset>
                <filter token="Version" value="${version}" />
                <filter token="Release" value="${build.number}" />
            </filterset>
        </copy>

        <exec executable="rpmbuild" failonerror="true">
            <arg value="--buildroot" />
            <arg file="${server.rpm.buildroot}"/>

            <arg value="--define"/>
            <arg value="_topdir ${server.rpm.topdir}"/>

            <arg value="--define"/>
            <arg value="_rpmdir ${server.rpm.rpmdir}"/>

            <arg value="--define"/>
            <arg value="_binary_payload w5.bzdio"/>

            <arg value="-bb" />
            <arg file="${server.rpm.specdir}/dcache-server-fhs.spec" />
        </exec>
    </target>
</project>
