<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html><head><title>PMD - XPath Rule tutorial</title><style type="text/css" media="all">
          @import url("./style/maven-base.css");
          
          @import url("./style/maven-theme.css");</style><link rel="stylesheet" href="./style/print.css" type="text/css" media="print"></link><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"></meta><meta name="author" content="Miguel Griffa"></meta><meta name="email" content="mikkey@users.sourceforge.net"></meta></head><body class="composite"><div id="banner"><a href="http://pmd.sourceforge.net/" id="organizationLogo"><img alt="InfoEther" src="http://sourceforge.net/sflogo.php?group_id=56262&amp;type=5"></img></a><a href="http://pmd.sourceforge.net/" id="projectLogo"><img alt="PMD" src="./images/pmd_logo_small.jpg"></img></a><div class="clear"><hr></hr></div></div><div id="breadcrumbs"><div class="xleft"></div><div class="xright">
        
        <a href="http://pmdapplied.com/" class="externalLink" title="External Link">**** Get the book! ****</a>
      
        
          
            <span class="separator">|</span>
          
        
        <a href="http://sourceforge.net/projects/pmd" class="externalLink" title="External Link">SourceForge.net Project Page</a>
      
        
          
            <span class="separator">|</span>
          
        
        <a href="http://sourceforge.net" class="externalLink" title="External Link">Hosted by SourceForge</a>
      </div><div class="clear"><hr></hr></div></div><div id="leftColumn"><div id="navcolumn"><div id="menuOverview"><h5>Overview</h5><ul><li class="none"><a href="http://sourceforge.net/project/showfiles.php?group_id=56262&amp;package_id=51441&amp;release_id=632850" class="externalLink" title="External Link">Download PMD 4.2.5</a></li><li class="none"><a href="http://sourceforge.net/project/shownotes.php?release_id=632850&amp;group_id=56262" class="externalLink" title="External Link">What's new in PMD 4.2.5</a></li><li class="none"><a href="news.html">PMD in the news</a></li><li class="none"><a href="products.html">PMD-related products and books</a></li><li class="none"><a href="bestpractices.html">Best practices</a></li><li class="none"><a href="future.html">Future directions</a></li><li class="none"><a href="similar-projects.html">Similar projects</a></li><li class="none"><a href="credits.html">Credits</a></li><li class="none"><a href="license.html">License</a></li><li class="none"><a href="meaning.html">What does 'PMD' mean?</a></li></ul></div><div id="menuUsage"><h5>Usage</h5><ul><li class="none"><a href="installing.html">Installation</a></li><li class="none"><a href="running.html">Command line usage</a></li><li class="none"><a href="ant-task.html">Ant task usage</a></li><li class="none"><a href="maven-plugin.html">Maven plugin usage</a></li><li class="none"><a href="mvn-plugin.html">Mvn plugin usage</a></li><li class="none"><a href="integrations.html">IDE plugin usage</a></li><li class="none"><a href="suppressing.html">Suppressing warnings</a></li><li class="none"><a href="cpd.html">Finding duplicated code</a></li><li class="none"><a href="jspsupport.html">JSP support</a></li></ul></div><div id="menuCustomizing_PMD"><h5>Customizing PMD</h5><ul><li class="none"><a href="compiling.html">Compiling PMD</a></li><li class="none"><a href="howtowritearule.html">How to write a rule</a></li><li class="none"><strong><a href="xpathruletutorial.html">Writing XPath rules</a></strong></li><li class="none"><a href="howtomakearuleset.html">How to make a rule set</a></li><li class="none"><a href="howitworks.html">How it works</a></li><li class="none"><a href="rule-guidelines.html">Rule guidelines</a></li></ul></div><div id="menuFor_example"><h5>For example</h5><ul><li class="none"><a href="scoreboard.html">Run PMD on a Sourceforge project</a></li></ul></div><div id="menuRule_Sets"><h5>Rule Sets</h5><ul><li class="none"><a href="rules/index.html">Index</a></li><li class="none"><a href="rules/android.html">Android</a></li><li class="none"><a href="rules/basic.html">Basic</a></li><li class="none"><a href="rules/braces.html">Braces</a></li><li class="none"><a href="rules/codesize.html">Code Size</a></li><li class="none"><a href="rules/clone.html">Clone</a></li><li class="none"><a href="rules/controversial.html">Controversial</a></li><li class="none"><a href="rules/coupling.html">Coupling</a></li><li class="none"><a href="rules/design.html">Design</a></li><li class="none"><a href="rules/finalizers.html">Finalizers</a></li><li class="none"><a href="rules/imports.html">Import Statements</a></li><li class="none"><a href="rules/j2ee.html">J2EE</a></li><li class="none"><a href="rules/javabeans.html">Javabeans</a></li><li class="none"><a href="rules/junit.html">JUnit Tests</a></li><li class="none"><a href="rules/logging-java.html">Logging (Java)</a></li><li class="none"><a href="rules/logging-jakarta-commons.html">Logging (Jakarta)</a></li><li class="none"><a href="rules/migrating.html">Migrating</a></li><li class="none"><a href="rules/naming.html">Naming</a></li><li class="none"><a href="rules/optimizations.html">Optimizations</a></li><li class="none"><a href="rules/strictexception.html">Strict Exceptions</a></li><li class="none"><a href="rules/strings.html">Strings</a></li><li class="none"><a href="rules/sunsecure.html">Sun Security</a></li><li class="none"><a href="rules/unusedcode.html">Unused Code</a></li><li class="none"><a href="rules/basic-jsp.html">Java Server Pages</a></li><li class="none"><a href="rules/basic-jsf.html">Java Server Faces</a></li></ul></div><div id="menuProject_Documentation"><h5>Project Documentation</h5><ul><li class="none"><a href="index.html">About</a></li><li class="collapsed"><a href="project-info.html">Project Info</a></li><li class="collapsed"><a href="maven-reports.html">Project Reports</a></li><li class="none"><a href="development-process.html">Development Process</a></li></ul></div><div id="legend"><h5>Legend</h5><ul><li class="externalLink">External Link</li><li class="newWindow">Opens in a new window</li></ul></div><a href="http://maven.apache.org/" title="Built by Maven" id="poweredBy"><img alt="Built by Maven" src="./images/logos/mavenlogo_builtby_w.png"></img></a></div></div><div id="bodyColumn"><div class="contentBox"><div class="section"><a name="XPath_Rule_tutorial"></a><h2>XPath Rule tutorial</h2>
<p>
Writing PMD rules with XPath can be a bit easier than writing rules with Java code.
    Here's an introduction on how to do that.
</p>
    <div class="subsection"><a name="Introduction"></a><h3>Introduction</h3>
    <p>PMD provides a very handy method for writing rules by writing an XPath query.
 When the XPath query finds a match, a violation is added to the report. This document
 focuses on XPath rules.  You can go <a href="howtowritearule.html">here</a> for more
 information about writing a rule.
    </p>
    </div>
    <div class="subsection"><a name="What_is_the_Abstract_Syntax_Tree__AST__"></a><h3>What is the Abstract Syntax Tree (AST)?</h3>
    <p>From <a href="http://foldoc.doc.ic.ac.uk/foldoc/foldoc.cgi?abstract+syntax+tree" class="externalLink" title="External Link">FOLDOC</a> an AST is 'A data structure
    representing something which has been parsed, often used as
    a compiler or interpreter's internal representation of a
    program while it is being optimised and from which code
    generation is performed'.</p>
    <p>
    	In our context, this means that we basically have a tree representation
    	of the Java source file.  This tree can viewed as a structured document - just like XML.
        And since it's conceptually similar to XML, it can be queried with XPath to find a pattern.
    </p>
    </div>

    <div class="section"><a name="Using_Designer"></a><h2>Using Designer</h2>
    <p> PMD comes with a handy tool that you will love if you want to write an XPath rule.
    Designer, runnable from a script in <code>bin/</code>, is a very simple and useful utility for writing rules.
    </p>
    <p>The basic steps involved in writing XPath rules are these:
    	<ol>
		    <li>Write a simple Java example source snippet in Designer</li>
		    <li>See the AST for the class you wrote</li>
		    <li>Write an XPath expression that matches the violation you are searching</li>
		    <li>Modify the Java class and go back to previous step to refine the XPath expression</li>
	    </ol>
    </p>

    </div>
    </div><div class="section"><a name="Simple_XPath_expressions"></a><h2>Simple XPath expressions</h2>
    <p>This section provides hands-on examples of XPath queries over the AST.
    You will probably find this section more useful if you follow it with
    Designer and copy/paste the examples.</p>
    <p>Copy the following Java source code to Designer:</p>
    
    <div class="source"><pre>
public class a {
	int fOne;
	int fTwo;

	private void run() {
		int one;
		int two;
	}
}
    </pre></div>
  
        <p>Let's assume you want to match something on class variable names. You
	see in the ASTVviewer that VariableDeclaratorId contains the variable name - in XML terms,
    the name is in the <code>@Image</code> attribute. So you try an
	XPath expression as follows: </p>
	
    <div class="source"><pre>//VariableDeclaratorId</pre></div>
  
	<p>If you try this expression you'll see that variables declared in
	methods are also matched. A more precise expression for matching field
	declarations is, well, using the FieldDeclaration node. This expression
	matches only the two fields declared in the class:</p>
	
    <div class="source"><pre>//FieldDeclaration</pre></div>
  
	<p>In a similar way, you can match only local variables with this
	expression</p>
	
    <div class="source"><pre>//LocalVariableDeclaration</pre></div>
  
	<p>With local variables we need to be more careful.  Consider the
	following class:</p>
	
    <div class="source"><pre>public class a {
	private void run() {
		final int one;
		int two;

		{
			int a;
		}
	}
}</pre></div>
  
	<p>Local variable declarations will match 'a', since it is a perfectly
	legal Java local variable. Now, a more interesting expression is
	to match variables declared in a method, and not on an internal block,
	nor in the class. Maybe you'll start with an expression like this:</p>
	
    <div class="source"><pre>//MethodDeclaration//LocalVariableDeclaration</pre></div>
  
	<p>You'll quickly see that all three local variables are matched.  A possible
	solution for this is to request that the parent of the local variable
	declaration is the MethodDeclaration node:</p>
	
    <div class="source"><pre>
        
    //LocalVariableDeclaration[name(../../..) = 'MethodDeclaration']
 
    </pre></div>
  
	<div class="subsection"><a name="Matching_variables_by_name"></a><h3>Matching variables by name</h3>
	<p>Let's consider that we are writing rules for logger. Let's assume we
	use the Java logging API and we want to find all classes that have more
	than one logger. The following expression returns all variable declarations
	whose type is 'Logger'. </p>
	
    <div class="source"><pre>//VariableDeclarator[../Type/ReferenceType/ClassOrInterfaceType[@Image='Log
ger']]</pre></div>
  
	<p>Finding a class with more than one logger is quite easy now. This
	expression matches the classes we are looking for.</p>
	
    <div class="source"><pre>TypeDeclaration[count(//VariableDeclarator[../Type/ReferenceType/ClassOrInt
erfaceType[@Image='Logger']])&gt;1]</pre></div>
  
	<p>But let's refine this expression a little bit more. Consider the
	following class:</p>
	
    <div class="source"><pre>public class a {
	Logger log = null;
	Logger log = null;
	int b;

	void myMethod() {
		Logger log = null;
		int a;
	}
	class c {
		Logger a;
		Logger a;
	}

}
</pre></div>
  
	<p>With this class we will only be matching one violation, when we
	probably would have wanted to produce two violations (one for each class).
	The following refined expression matches classes that contain more than one logger.</p>
	
    <div class="source"><pre>//ClassOrInterfaceBodyDeclaration[count(//VariableDeclarator[../Type/ReferenceType/ClassOrInterfaceType[@Image='Logger']])&gt;1]</pre></div>
  
	<p>Let's assume we have a Factory class, that could be always declared final.
	We'll search an xpath expression that matches all declarations of Factory
	and reports a violation if it is not declared final.
	Consider the following class:</p>
	
    <div class="source"><pre>public class a {
	Factory f1;

	void myMethod() {
		Factory f2;
		int a;
	}
}
</pre></div>
  
	<p>The following expression does the magic we need:</p>
	
    <div class="source"><pre>
//VariableDeclarator
 [../Type/ReferenceType/ClassOrInterfaceType
  [@Image = 'Factory'] and ..[@Final='false']]
 
    </pre></div>
  
	<p>I must recommend at this point that you experiment with Designer putting
	the final modifier to the Factory and verifying that the results produced
	are those expected.</p>

     <p>Finally, for many more details on writing XPath rules, pick up <a href="http://pmdapplied.com/" class="externalLink" title="External Link">PMD Applied</a>!</p>
	</div>


   </div></div></div><div class="clear"><hr></hr></div><div id="footer"><div class="xright">© 2002-2009, InfoEther</div><div class="clear"><hr></hr></div></div></body></html>