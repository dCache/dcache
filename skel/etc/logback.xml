<configuration>

  <!-- dCache logs to a hierarchy of log targets or loggers. The root
       of this hierarchy is called root. All other loggers have a name
       that is typically the class name of the component logging. Most
       of the time the specific name of a logger is not important, as
       one typically only adjusts the log level of the root
       logger. Unless specifically redefined, the log level is
       inherited from the parent logger and ultimately from the root
       logger.

       Appenders are output components that write log messages
       somewhere. In dCache, log files are generated by redirecting
       standard out to the log file. Hence there is a ConsoleAppender
       for logging to stdout. Another appender directs log messages to
       the cell pinboard. The pinboard is accessible through the
       dCache admin shell.

       Please consult the logback manual for information about other
       appenders. There exist appenders for writing directly to log
       files, remote logging, logging through syslog, and to generate
       emails.

       Appenders are attached to loggers at specific points in the
       logger hierarchy, typically the root.

       In logback classic the log level is adjusted directly for a
       logger. This proves insufficient for dCache. Therefore we
       instantiate a CellThresholdFilter. This filter allows the log
       level to be defined for a logger per appender and per
       cell. Thus rather than adjusting the log level of a logger
       globally, one adjusts it for a specific appender and a specific
       cell. The filter can be readjusted for each cell at runtime
       through the dCache admin shell.

       Besides the inheritance in the logger hiearchy, log level
       definitions are inherited between cells: If a cell creates
       another cell, then the log level definitions of the parent cell
       are inherited. This is relevant for doors that create a cell
       instance per connection: The log level can be adjusted for the
       master door cell and the cells created per connection will
       inherit the log levels from the master cell. The root of this
       inheritance hirarchy is defined in the filter definition below
       as threshold-tags. Each tag defines a log level for a
       particular logger. The definition can be limited to a
       particular appender or apply to all appenders.

       Given a particular appender, the algorithm for determining the
       effective log level for a logger l and a cell c is:

       1. If a log level for l and c is defined then that is the effective
          log level.

       2. Otherwise use the log level for l in the lowest ancestor of c
          for which the log level is defined.

       3. If there is no such lowest ancestor for c, then use the
          effective log level for c of the parent logger.

       Don't worry too much about the specific algorithm. You do not
       need to understand it in details to adjust log levels at
       runtime through the dCache admin shell.
  -->

  <appender name="stdout" class="ch.qos.logback.core.ConsoleAppender">
    <encoder>
      <pattern>%d{dd MMM yyyy HH:mm:ss} \(%X{cells.cell}\) [%X{org.dcache.ndc}] %m%n</pattern>
    </encoder>
  </appender>

  <appender name="pinboard" class="dmg.util.PinboardAppender">
    <layout>
      <pattern>[%t] [%X{org.dcache.ndc}] %m</pattern>
    </layout>
  </appender>

  <appender name="events" class="ch.qos.logback.core.FileAppender">
    <file>/tmp/events-${domain.name}.out</file>
    <encoder>
      <pattern>ts=%d{yyyy-MM-dd}T%d{HH:mm:ss.SSS} %m%n</pattern>
    </encoder>
  </appender>

  <appender name="traceFile" class="ch.qos.logback.core.rolling.RollingFileAppender">
    <file>/tmp/trace-${domain.name}.out</file>
    <rollingPolicy class="ch.qos.logback.core.rolling.FixedWindowRollingPolicy">
      <fileNamePattern>trace-${domain.name}.out.%i</fileNamePattern>
      <minIndex>1</minIndex>
      <maxIndex>1</maxIndex>
    </rollingPolicy>
    <triggeringPolicy class="ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy">
      <maxFileSize>100MB</maxFileSize>
    </triggeringPolicy>
    <encoder>
      <pattern>%d{yyMMdd HH:mm:ss} (%X{cells.cell}@%X{cells.domain}) [%t] [%x] %c %l %m%n</pattern>
    </encoder>
  </appender>

  <!-- appender name="transactionlog" class="ch.qos.logback.core.FileAppender">
    <file>/tmp/transaction.log</file>
    <encoder>
      <pattern>%d{dd MMM yyyy HH:mm:ss} %m%n</pattern>
    </encoder>
  </appender-->

  <!-- currently used only for sending alarms to a remote logback server;
       note that remoteHost and port may require modification depending on
       the installation -->
  <appender name="remote" class="ch.qos.logback.classic.net.SocketAppender">
      <remoteHost>${alarms.server.host}</remoteHost>
      <port>${alarms.server.port}</port>
      <reconnectionDelay>10000</reconnectionDelay>
  </appender>

  <!-- processes events from all loggers into alarms on the basis of the
       alarmType definitions provided; for further information,
       see the javadoc for org.dcache.alarms.logback.AlarmDefinition and
       the dCache Book -->
  <appender name="alarms" class="org.dcache.alarms.logback.AlarmDefinitionAppender">
      <!-- this filter determines which events are to be interpreted as alarms;
          the appender converts these into alarm events and passes them
          to its embedded child appender(s)
      -->
      <filter class="org.dcache.alarms.logback.AlarmDefinitionFilter">
            <alarmType>
                regex:"(.+) from ac_create",
                type:SERVICE_CREATION_FAILURE,
                level:ERROR,
                severity:CRITICAL,
                include-in-key:group1 type host domain service
            </alarmType>
            <alarmType>
                regex:"Failed to acquire connection.+Attempts left: 0",
                type:DB_OUT_OF_CONNECTIONS,
                level:ERROR,
                severity:CRITICAL,
                include-in-key:type host
            </alarmType>
            <alarmType>
                regex:"Unable to open a test connection to the given database|Connections could not be acquired from the underlying database",
                match-exception:true,
                depth:1,
                type:DB_UNAVAILABLE,
                level:ERROR,
                severity:CRITICAL,
                include-in-key:type host
            </alarmType>
            <alarmType>
                regex:"OutOfMemory",
                type:JVM_OUT_OF_MEMORY,
                level:ERROR,
                severity:CRITICAL,
                include-in-key:type host domain
            </alarmType>
            <alarmType>
                regex:"[Tt]oo many open files",
                type:OUT_OF_FILE_DESCRIPTORS,
                match-exception:true,
                level:ERROR,
                severity:CRITICAL,
                include-in-key:type host domain
            </alarmType>
            <alarmType>
                regex:"I/O.*failed(.+)|I/O error occur.*ed(.+)",
                type:IO_ERROR,
                level:WARN,
                severity:HIGH,
                include-in-key:group1 type host service domain
            </alarmType>
            <alarmType>
                regex:"Fetch failed: HSM script failed",
                type:HSM_READ_FAILURE,
                level:WARN,
                severity:HIGH,
                include-in-key:type host service domain
            </alarmType>
            <alarmType>
                regex:"Store failed: HSM script failed",
                type:HSM_WRITE_FAILURE,
                level:WARN,
                severity:HIGH,
                include-in-key:type host service domain
            </alarmType>
            <alarmType>
                regex:"Timeout querying location manager",
                type:LOCATION_MANAGER_UNAVAILABLE,
                level:WARN,
                severity:HIGH,
                include-in-key:type host service domain
            </alarmType>
            <alarmType>
                regex:"PoolManager.+not found",
                type:POOL_MANAGER_UNAVAILABLE,
                level:WARN,
                severity:HIGH,
                include-in-key:type host service domain
            </alarmType>
            <alarmType>
                regex:"Pool mode changed to disabled",
                type:POOL_DISABLED,
                level:WARN,
                severity:MODERATE,
                include-in-key:type host service domain
            </alarmType>
            <alarmType>
                logger:org.dcache.pool.classic.ChecksumScanner,
                regex:"Checksum mismatch detected for (.+) - marking as BROKEN",
                type:CHECKSUM,
                level:ERROR,
                severity:MODERATE,
                include-in-key:group1 type host service domain
            </alarmType>
      </filter>
      <appender-ref ref="remote"/>
  </appender>

  <root>
    <appender-ref ref="stdout"/>
    <appender-ref ref="pinboard"/>
    <appender-ref ref="alarms"/>
  </root>

  <logger name="events" additivity="false">
    <appender-ref ref="events"/>
  </logger>

  <!-- dCache developers logging -->
  <logger name="logger.dev" additivity="false">
    <appender-ref ref="traceFile"/>
  </logger>
  <logger name="dev" additivity="false">
    <appender-ref ref="traceFile"/>
  </logger>

  <!-- Nothing is logged to this logger. Its sole purpose is to list
       all appenders available; this ensures that the appenders are
       available in the dCache admin interface. -->
  <logger name="dummy" level="OFF">
    <appender-ref ref="stdout"/>
    <appender-ref ref="pinboard"/>
    <appender-ref ref="traceFile"/>
    <appender-ref ref="events"/>
    <appender-ref ref="alarms"/>
  </logger>

  <turboFilter class="dmg.util.logback.CellThresholdFilter">
    <!-- Important: This turboFilter must be instantiated after
                    appenders and loggers have been instantiated. -->
    <onHigherOrEqual>ACCEPT</onHigherOrEqual>
    <onLower>DENY</onLower>
    <threshold>
      <logger>root</logger>
      <level>off</level>
    </threshold>
    <threshold>
      <logger>dmg.cells.nucleus</logger>
      <level>warn</level>
    </threshold>
    <threshold>
      <logger>COM.claymoresystems.ptls.SSLDebug</logger>
      <level>off</level>
    </threshold>
    <threshold>
      <logger>logger.org.dcache.cells.messages</logger>
      <level>error</level>
    </threshold>
    <threshold>
      <logger>org.glite.security.trustmanager.CRLFileTrustManager</logger>
      <level>error</level>
    </threshold>
    <threshold>
      <logger>org.glite.security.trustmanager.ContextWrapper</logger>
      <level>off</level>
    </threshold>
    <threshold>
      <logger>org.glite.security.trustmanager.axis.AXISSocketFactory</logger>
      <level>off</level>
    </threshold>
    <threshold>
      <logger>org.glite.security.util.DirectoryList</logger>
      <level>off</level>
    </threshold>

    <threshold>
      <logger>liquibase</logger>
      <level>warn</level>
    </threshold>

    <threshold>
      <appender>stdout</appender>
      <logger>root</logger>
      <level>warn</level>
    </threshold>

    <threshold>
      <appender>alarms</appender>
      <logger>root</logger>
      <level>warn</level>
    </threshold>

    <threshold>
      <appender>pinboard</appender>
      <logger>root</logger>
      <level>info</level>
    </threshold>

    <threshold>
      <appender>events</appender>
      <logger>events</logger>
      <level>off</level>
    </threshold>

    <threshold>
      <appender>traceFile</appender>
      <logger>logger.dev</logger>
      <level>off</level>
    </threshold>

    <threshold>
      <appender>traceFile</appender>
      <logger>dev</logger>
      <level>off</level>
    </threshold>

  </turboFilter>
</configuration>
